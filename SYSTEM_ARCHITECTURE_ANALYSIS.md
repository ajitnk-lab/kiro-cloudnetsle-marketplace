# System Architecture Analysis
**CloudNetsle Marketplace & AWS Solution Finder Integration**

## Overview
Two integrated CDK projects working together:
1. **Marketplace (Control Plane)** - `/home/ubuntu/workspace/7nov-marketing/marketplace-project`
2. **FAISS Solution Finder (Data Plane)** - `/home/ubuntu/workspace/faiss-rag-agent`

---

## 1. Marketplace App (Control Plane)

### Purpose
Self-service marketplace platform for buying/selling software solutions with tiered access control.

### Tech Stack
- **Backend**: AWS CDK (TypeScript), Lambda (Node.js 18)
- **Frontend**: React 18 + TypeScript + Vite + Tailwind CSS
- **Database**: DynamoDB (users, entitlements, sessions, solutions)
- **Auth**: Cognito User Pools
- **Payment**: PhonePe Gateway integration
- **Hosting**: S3 + CloudFront

### Key Resources
- **Stack Name**: `MP-1762926799834`
- **Production URL**: https://marketplace.cloudnestle.com
- **API Gateway**: https://juvt4m81ld.execute-api.us-east-1.amazonaws.com/prod/

### DynamoDB Tables
1. **marketplace-users** - User profiles and authentication
2. **marketplace-user-solution-entitlements** - Access control and usage tracking
3. **marketplace-sessions** - User session tracking with location data
4. **marketplace-solutions** - Solution catalog
5. **marketplace-payment-transactions** - Payment records
6. **marketplace-partner-applications** - Partner onboarding
7. **marketplace-tokens** - Token management

### Access Tiers
- **Anonymous**: 3 searches (tracked in FAISS local DDB)
- **Registered**: 10 searches/day (tracked in marketplace DDB)
- **Pro**: Unlimited searches (paid tier via PhonePe)

### Critical Lambda Functions

#### `/lambda/tokens/solution-token-validator.js`
**Endpoint**: `POST /api/validate-solution-token`

**Purpose**: Validates marketplace tokens and enforces usage quotas

**Request**:
```json
{
  "token": "user-token-string",
  "solution_id": "aws-solution-finder",
  "user_email": "user@example.com",  // optional
  "check_only": false  // true = don't increment usage
}
```

**Response (Success)**:
```json
{
  "allowed": true,
  "user_email": "user@example.com",
  "solution_id": "aws-solution-finder",
  "access_tier": "registered|pro",
  "quota_remaining": 10,  // -1 for unlimited
  "quota": {
    "daily_limit": 10,
    "daily_used": 0,
    "unlimited": false
  }
}
```

**Response (Quota Exceeded)**:
```json
{
  "error": "Quota exceeded",
  "reason": "daily_limit_exceeded",
  "limit": 10,
  "used": 10,
  "access_tier": "registered"
}
```

**Key Features**:
- Supports both email-based (old) and UUID-based (new) entitlement formats
- Tracks daily usage per user
- Pro tier gets unlimited access (`daily: -1`)
- Location tracking via CloudFront headers
- Atomic usage increment (unless `check_only: true`)

#### `/lambda/tokens/solution-token-generator.js`
**Endpoint**: `POST /api/generate-solution-token`

**Purpose**: Creates entitlements when users register from FAISS app

**Flow**:
1. User clicks "Register" in FAISS app
2. Redirects to: `https://marketplace.cloudnestle.com/register?solution_id=aws-solution-finder`
3. After registration, generates token and creates entitlement
4. Returns token to user for FAISS app usage

### Deployment Script
**File**: `/home/ubuntu/workspace/7nov-marketing/marketplace-project/deploy-full.sh`

**Critical**: ALWAYS use this script - it ensures:
1. Updates FAISS `.env` with current table names
2. Deploys CDK infrastructure
3. Extracts CloudFormation outputs
4. Updates frontend `.env` with current resource IDs
5. Builds frontend with correct config
6. Deploys to both S3 buckets (CDK + production)
7. Invalidates both CloudFront distributions

**Never run `cdk deploy` directly** - causes configuration drift!

---

## 2. FAISS Solution Finder App (Data Plane)

### Purpose
AI-powered AWS solution search using FAISS vector search + Amazon Bedrock Nova Pro.

### Tech Stack
- **Backend**: AWS CDK (TypeScript), Lambda (Python 3.11)
- **Frontend**: Vanilla HTML/JavaScript (single file)
- **Vector DB**: FAISS (in-memory)
- **AI**: Amazon Bedrock (Nova Pro)
- **Database**: Local DynamoDB (anonymous tracking) + Marketplace DDB (registered users)
- **Hosting**: S3 + CloudFront

### Key Resources
- **Production URL**: https://awssolutionfinder.solutions.cloudnestle.com/search
- **Lambda**: Python-based query handler with FAISS index

### Environment Configuration
**File**: `/home/ubuntu/workspace/faiss-rag-agent/.env`

```bash
# Auto-generated by marketplace deploy-full.sh
MARKETPLACE_USER_TABLE_NAME=marketplace-users
MARKETPLACE_ENTITLEMENT_TABLE_NAME=marketplace-user-solution-entitlements
MARKETPLACE_SESSION_TABLE_NAME=marketplace-sessions
MARKETPLACE_API_URL=https://juvt4m81ld.execute-api.us-east-1.amazonaws.com/prod/
```

### Lambda Function
**File**: `/home/ubuntu/workspace/faiss-rag-agent/lambda/query_handler.py`

**Key Function**: `validate_marketplace_token(token, user_id, check_only=False)`

**Integration Flow**:
```python
# 1. Validate token with marketplace API
response = requests.post(
    'https://juvt4m81ld.execute-api.us-east-1.amazonaws.com/prod/api/validate-solution-token',
    json={
        'token': token,
        'action': 'search',
        'solution_id': 'aws-solution-finder',
        'check_only': check_only  # Don't increment usage if just checking
    }
)

# 2. Handle response
if response.status_code == 200:
    data = response.json()
    if data['access_tier'] == 'pro':
        return {'allowed': True, 'usage_remaining': -1}  # Unlimited
    else:
        return {'allowed': True, 'usage_remaining': data['quota_remaining']}
        
elif response.status_code == 429:
    # Quota exceeded - show upgrade prompt
    return {'allowed': False, 'quota_exceeded': True}
```

### User Flow

#### Anonymous User (0-3 searches)
1. Visit https://awssolutionfinder.solutions.cloudnestle.com/search
2. Perform search (no auth required)
3. Usage tracked in local FAISS DynamoDB table
4. After 3 searches: "Register to continue" prompt

#### Registered User (4-13 searches)
1. Click "Register" â†’ Redirects to marketplace with `?solution_id=aws-solution-finder`
2. Complete registration in marketplace
3. Marketplace generates token and creates entitlement
4. User returns to FAISS with token
5. Token stored in localStorage
6. Each search validates token with marketplace API
7. Usage tracked in marketplace DDB
8. After 10 searches: "Upgrade to Pro" prompt

#### Pro User (Unlimited)
1. Click "Upgrade to Pro" in FAISS app
2. Redirects to marketplace payment flow
3. PhonePe payment gateway integration
4. On success: Entitlement updated to `access_tier: 'pro'`
5. Unlimited searches (quota check returns `-1`)

---

## 3. Integration Points

### Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FAISS Solution Finder                     â”‚
â”‚              (awssolutionfinder.solutions.cloudnestle.com)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ 1. User searches
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  query_handler.py  â”‚
                  â”‚   (Lambda Python)  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ 2. Validate token
                           â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  POST /api/validate-solution-token      â”‚
         â”‚  (Marketplace Control Plane API)        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ 3. Check entitlement
                           â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  marketplace-user-solution-entitlements â”‚
         â”‚  (DynamoDB)                             â”‚
         â”‚  - Check access_tier                    â”‚
         â”‚  - Check daily usage                    â”‚
         â”‚  - Increment usage counter              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ 4. Return validation result
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  FAISS Lambda      â”‚
                  â”‚  - Allow/Deny      â”‚
                  â”‚  - Show quota      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Token Lifecycle

```
1. Registration Flow:
   FAISS â†’ marketplace.cloudnestle.com/register?solution_id=aws-solution-finder
   â†’ User registers
   â†’ generate-solution-token.js creates entitlement
   â†’ Token returned to user
   â†’ Stored in localStorage

2. Usage Flow:
   FAISS search â†’ validate_marketplace_token()
   â†’ POST /api/validate-solution-token
   â†’ Check quota
   â†’ Increment usage (if allowed)
   â†’ Return result

3. Upgrade Flow:
   FAISS "Upgrade" button â†’ marketplace payment page
   â†’ PhonePe payment
   â†’ Update entitlement: access_tier = 'pro'
   â†’ Unlimited access
```

### Entitlement Schema

**New Format (UUID-based)**:
```json
{
  "pk": "user#uuid-123",
  "sk": "solution#aws-solution-finder",
  "token": "generated-token-string",
  "solution_id": "aws-solution-finder",
  "accessTier": "registered|pro",
  "dailyUsage": 5,
  "lastUsageDate": "2025-11-23",
  "createdAt": "2025-11-01T10:00:00Z",
  "updatedAt": "2025-11-23T09:30:00Z"
}
```

**Old Format (Email-based)**:
```json
{
  "pk": "user#user@example.com",
  "sk": "solution#aws-solution-finder",
  "token": "generated-token-string",
  "solution_id": "aws-solution-finder",
  "access_tier": "registered|pro",
  "usage": {
    "daily_usage": {
      "2025-11-23": 5
    }
  },
  "status": "active",
  "created_at": "2025-11-01T10:00:00Z",
  "updated_at": "2025-11-23T09:30:00Z"
}
```

**Note**: Validator handles both formats for backward compatibility.

---

## 4. Deployment Process

### Marketplace Deployment

```bash
cd /home/ubuntu/workspace/7nov-marketing/marketplace-project
./deploy-full.sh
```

**What it does**:
1. Updates FAISS `.env` with current marketplace table names
2. Deploys backend CDK stack
3. Extracts CloudFormation outputs
4. Updates frontend `.env`
5. Builds frontend
6. Syncs to S3 (both CDK and production buckets)
7. Invalidates CloudFront caches

### FAISS Deployment

```bash
cd /home/ubuntu/workspace/faiss-rag-agent
./deploy.sh
```

**Prerequisites**: Marketplace must be deployed first (FAISS reads `.env` for table names)

---

## 5. Key Learnings

### Always Use deploy-full.sh
- **Never** run `cdk deploy` directly for marketplace
- Script ensures environment consistency across frontend/backend
- Auto-updates FAISS configuration

### Token Validation is Critical
- FAISS calls marketplace API for every search
- Marketplace enforces quotas atomically
- Pro tier bypasses quota checks (`daily: -1`)

### Dual Format Support
- Validator handles both old (email) and new (UUID) entitlement formats
- Ensures backward compatibility during migration

### Location Tracking
- Uses CloudFront headers for geo-location
- Stored in marketplace-sessions table
- Privacy-conscious (IP hashing)

### Payment Integration
- PhonePe gateway for Indian market
- Webhook reconciliation for payment confirmation
- Automatic tier upgrade on successful payment

---

## 6. Current Status

### âœ… Completed
- Marketplace token validation system
- FAISS backend integration with marketplace
- Solution token generation and validation APIs
- Tiered access control (anonymous/registered/pro)
- Usage tracking and quota enforcement
- PhonePe payment integration
- Location tracking

### ğŸš§ Active
- Both systems deployed and operational
- Real-time API validation working
- User registration and upgrade flows functional

### ğŸ“ Important Notes
- Always deploy marketplace before FAISS
- Use `deploy-full.sh` for marketplace changes
- Check CloudFormation outputs for current resource IDs
- Monitor DynamoDB for usage patterns
- Test payment webhooks in staging first

---

## 7. Troubleshooting

### FAISS can't validate tokens
1. Check marketplace API is responding: `curl https://juvt4m81ld.execute-api.us-east-1.amazonaws.com/prod/api/validate-solution-token`
2. Verify FAISS `.env` has correct table names
3. Check Lambda logs in CloudWatch

### Quota not updating
1. Verify entitlement exists in DynamoDB
2. Check `check_only` flag is not set
3. Confirm access_tier is correct

### Payment not upgrading tier
1. Check PhonePe webhook is configured
2. Verify payment transaction in marketplace-payment-transactions table
3. Check entitlement was updated to `access_tier: 'pro'`

---

**Last Updated**: 2025-11-23  
**Analyzed By**: Amazon Q Developer
